{% extends 'orders/base.html' %}
{% load static %}

{% block title %}
    {{ page_title|title }}
{% endblock %}

{% block page_header %}
    <h1>РЕЕСТР ПРИКАЗОВ <br>ФГКОУ «Объединенный Санкт-Петербургский кадетский корпус <br>Следственного комитета Российской Федерации <br>имени Маршала Советского Союза Г.К. Жукова»</h1>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h2>Список приказов</h2>
        {% include 'orders/includes/inc__filter.html' %}
        {% include 'orders/includes/inc__main_menu.html' %}

        <div class="table-responsive mt-3">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Номер документа</th>
                        <th scope="col">Дата издания</th>
                        <th scope="col">Название документа</th>
                        <th scope="col">Кем подписан документ</th>
                        <th scope="col">Ответственный исполнитель</th>
                        <th scope="col">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr class="{% if not order.is_active %}table-secondary{% endif %}">
                        <th scope="row">
                            {% if page_obj %}
                                {{ forloop.counter0|add:page_obj.start_index }}
                            {% else %}
                                {{ forloop.counter }}
                            {% endif %}
                        </th>
                        <td>
                            <a href="#" class="link-primary text-decoration-none view-detail-btn"
                               data-bs-toggle="modal"
                               data-bs-target="#modalContainer"
                               data-url="{% url 'orders:detail_order' order.pk %}"
                               title="Посмотреть полную карточку">
                                <strong>{{ order.document_number }}</strong>
                            </a>
                        </td>
                        <td>{{ order.issue_date|default_if_none:"---" }}</td>
                        <td>{{ order.document_title|truncatechars:100 }}</td>
                        <td>{{ order.signed_by|default_if_none:"---" }}</td>
                        <td>{{ order.responsible_executor|default_if_none:"---" }}</td>
                        <td class="text-nowrap">
                            <a href="#" class="text-decoration-none me-2 edit-btn"
                               data-bs-toggle="modal"
                               data-bs-target="#modalContainer"
                               data-url="{% url 'orders:edit_order' order.pk %}"
                               title="Редактировать">

                            </a>
                            <a href="{% url 'orders:delete_order' order.pk %}" class="text-decoration-none" title="Удалить">

                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">
                            По вашему запросу ничего не найдено.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
            {% endif %}
    </div>

    <div class="modal fade" id="modalContainer" tabindex="-1" aria-labelledby="modalContainerLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                </div>
        </div>
    </div>

{% endblock content %}

{% block scripts %}
    {{ block.super }}
    <script>
        $(document).ready(function() {
            var modalContainer = $('#modalContainer');
            var modalContent = modalContainer.find('.modal-content');

            // Обработчик клика для всех кнопок, которые должны открывать модальное окно
            $('.view-detail-btn, .edit-btn').on('click', function(e) {
                e.preventDefault();
                var url = $(this).data('url');

                // Очистка предыдущего содержимого и показ спиннера
                modalContent.html('<div class="d-flex justify-content-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>');

                // Асинхронная загрузка контента в модальное окно
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(data) {
                        modalContent.html(data);
                    },
                    error: function() {
                        modalContent.html('<div class="modal-header"><h5 class="modal-title">Ошибка</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><p class="text-danger">Не удалось загрузить данные. Попробуйте снова.</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button></div>');
                    }
                });
            });

            // Обработчик для форм внутри модального окна (для сохранения изменений без перезагрузки)
            modalContainer.on('submit', 'form', function(e) {
                e.preventDefault();
                var form = $(this);

                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: new FormData(form[0]), // FormData для обработки файлов
                    processData: false,
                    contentType: false,
                    success: function(data) {
                        // Если в ответ приходит форма (значит, были ошибки валидации)
                        if (data.indexOf('modal-body') > -1) {
                            modalContent.html(data);
                        } else {
                            // Если успешно сохранено, закрываем модальное окно и перезагружаем страницу (или обновляем строку таблицы)
                            modalContainer.modal('hide');
                            location.reload(); // Простейший способ обновления
                        }
                    },
                    error: function() {
                        alert('Произошла ошибка при сохранении данных.');
                    }
                });
            });

        });
    </script>
{% endblock scripts %}